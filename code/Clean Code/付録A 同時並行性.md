p412

マルチスレッド化により解決できるのかは、まずシステムのどの部分で時間が掛かっているのかを事前に考える必要がある

考えられるのは2つ

- I/O: ソケットアクセス、データベースへの接続、仮想メモリのスワッピング待ち
- プロセッサ: 数値計算、正規表現の処理、ガベージコレクション

コードがプロセッサ依存のものであれば、処理装置の増強により改善される

→ 並行化しても、早くはならない

コードがI/O関連であれば、同時並行は効率を向上させる。

→ システムのある部分がI/O待ちの時、別の部分はその間に処理ができる

同時並行は複雑なため、コードをカプセル化し単一責務にすることはとても重要

p417

実行経路の数

前提

- 生成されたバイトコードから調べる必要がある
    - **バイトコード (bytecode)** は、プログラムのソースコードをコンパイルして生成される中間形式のコードです。
    - Ex.
        - コード
            
            ```python
            x = 5
            y = x + 2
            print(y)
            ```
            
        - バイトコード
            
            ```python
              0 LOAD_CONST               1 (5)
              2 STORE_NAME               0 (x)
              4 LOAD_NAME                0 (x)
              6 LOAD_CONST               2 (2)
              8 BINARY_ADD
             10 STORE_NAME               1 (y)
             12 LOAD_NAME                2 (print)
             14 LOAD_NAME                1 (y)
             16 CALL_FUNCTION            1
             18 POP_TOP
             20 LOAD_CONST               0 (None)
             22 RETURN_VALUE
            ```
            
- バイトコードの数をNとする。スレッドをTとすると、全体のステップ数はN×T。
    - バイトコードが2つ、スレッドが2つだと全体のステップ数は4になる

計算

1. ステップの組み合わせを考えると、スレッド1が「1」、スレッド2が「2」で表され、命令の進行状況により次のような文字列が生成されます:
    
    ```python
    1122, 1212, 1221, 2112, 2121, 2211, ....
    ```
    
2. 各文字列には、**「1が2つ」**、**「2が2つ」** 含まれています。
3. 「1が2つ」、「2が2つ」という条件は、次のように配置を入れ替えても同じ意味を持ちます:
    1. たとえば、`1122` の先頭の「1」と2番目の「1」、3番目の「2」と4番目の「2」を入れ替えても文字列としての意味は変わらない。
4. この重複を取り除くには、全順列数を以下のように修正します
    - **総順列数**: 4!=24
    - **重複の種類**: 「1の並び替え数」 × 「2の並び替え数」 `= 2!×2! = 2×2=4`
        
        ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/a643e5c2-0b43-4ddb-a882-7a28e8718617/image.png)
        

一般的なケース

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/c66705ee-8899-4535-a09a-ec183c5b1c8f/image.png)

- 具体例 バイトコードの数が3 スレッドが2の場合
    - 文字列の並び(一部)
        
        ```python
        111222, 112122, 112212, 121122, 121212 ...
        ```
        
    - 総合順列数
        - 命令が6つ（`111222`）なので、順列の全通りは： 6! = 720
    - 重複
        - 数字 `1` が3回 → 3! 通りの重複
        - 数字`2`が3回 → 3!通りの重複
        
        ＝ (3!)の2乗
        
    - 計算
        
        ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/c6f2872c-c998-4f65-ab23-abd852cc24a7/image.png)
        
    - 答え
        - 20通り