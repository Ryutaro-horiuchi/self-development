## 不変性とアーキテクチャ

- 関数型言語の変数は**変化しない**
- アーキテクチャの観点からすると、変数が不変であることは重要である
    - 競合状態、デッドロック状態、平行更新の問題の原因は可変変数にある。不変であればこれらの問題は起こらない
- 「不変性は実際に使えるのか？」という問いに対し、　ストレージとプロセッサが無限にあれば、答えは肯定的なものとなる。無限になければ、答えは微妙になる。
    
    → ある程度の妥協ができれば、不変は実際には使える
    

## 妥協の仕方

### 可変性の分離

アプリケーションのサービスを、「可変コンポーネント」「不変コンポーネント」とに分ける

- 不変コンポーネントは、可変変数を使わずに、純粋に関数的にタスクを行う
- 可変コンポーネントは、変数の状態の変更を許可している
    - 状態の変更により、並行性の問題が出てくる。変更可能な変数を並行更新や競合状態から保護するために、トランザクショナルメモリを使用するのが一般的である
        - トランザクショナルメモリ
            - メモリへの読み書きをトランザクション（atomicな操作単位）として扱い、これらのトランザクションが安全かつ効率的に並行実行されるようにする仕組み

### イベントソーシング

- 状態ではなく、取引を保存する
    - ex. 銀行の口座残高
        - 通常の考えのシステムだと口座残高をデータとして持ち、取引があった場合は残高を変更する
        - イベントソーシングだと口座残高ではなく取引のみを保存し、残高を知りたい場合は、これまでの取引全てを合計して算出する
            - → 膨大なストレージ容量が必要になるが、アプリケーションを完全に不変にできる