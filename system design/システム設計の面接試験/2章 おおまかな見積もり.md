## はじめに

システム容量や性能要件を大雑把に見積もるように依頼される

Googleのジェフ・ディーンによれば、「おおまかな見積もりとは、思考実験と一般的な性能数値を組み合わせて、どの設計が要件を満たすかについて良い感触を得るために行う見積もり」とのこと

## 2のべき乗

- 正しい計算には、データ量の単位を2のべき乗で把握するのが重要
- データ容量の単位
    
    ![IMG_6630.jpeg](attachment:df4e3774-ea6f-489a-8bb0-67d74c7a0804:IMG_6630.jpeg)
    
    - ASCII文字は1バイト(8ビット)のメモリを消費する

## プログラマが知っておくべきレイテンシの数値

Googleのジェフ・ディーンは、典型的なコンピューター操作の時間を明らかにしている

- 表
    
    
    | 操作名 | 内容の説明 | 処理時間 |
    | --- | --- | --- |
    | **L1キャッシュ参照** | CPUに最も近い高速・小容量のキャッシュへのアクセス。 | 0.5ns |
    | **分岐予測ミス** | 条件分岐の予測が外れた際のペナルティで、命令パイプラインの再実行が発生。 | 5ns |
    | **L2キャッシュ参照** | L1より大容量・やや遅いキャッシュメモリへのアクセス。 | 7ns |
    | **ミューテックスのロック／アンロック** | スレッド間での排他制御を行う処理（ロック獲得と解放）。 | 100ns |
    | **メインメモリ参照** | RAMからの読み書き。キャッシュミス時に発生する。 | 100ns |
    | **1KBのzip圧縮** | CPUを用いたデータ圧縮処理（1KB）。CPU負荷がかかる。 | 10,000ns = 10μs |
    | **1Gbpsネットワーク上の2KB送付** | 1Gbpsのネットワークでの小さなデータ送信。 | 20,000ns = 20μs |
    | **メモリからの1MBの連続読込み** | RAMから1MBのデータを一括で読み込む処理。 | 250,000ns = 250μs |
    | **同一データセンター内の往復** | 同じDC内でのサーバ間通信。遅延は非常に小さい。 | 500,000ns = 500μs |
    | **ディスクのシーク** | HDDのヘッドを物理的に移動させる操作。ランダムアクセス時に発生。 | 10,000,000ns = 10ms |
    | **ネットワークからの1MBの連続読込み** | ネットワーク越しに1MBを連続で取得する操作。 | 10,000,000ns = 10ms |
    | **ディスクからの1MBの連続読込み** | ストレージデバイスから大容量データを読み込む操作。 | 30,000,000ns = 30ms |
    | **カリフォルニア－オランダ間の往復パケット送付** | 米国と欧州間のインターネット通信。光速とネット遅延を含む。 | 150,000,000ns = 150ms |
    - 単位の補足
        - **ns (ナノ秒)** = 10⁻⁹秒（非常に高速）
        - **μs (マイクロ秒)** = 10⁻⁶秒
        - **ms (ミリ秒)** = 10⁻³秒
- 表からわかること
    - メモリは早いが、ディスクは遅い
    - 可能ならディスクのシークは避ける
        - **ディスクのシーク**は「ヘッドの物理移動」で発生するHDD特有の遅延。
        - HDDはCDのような**回転する円盤（プラッタ）と、その表面を読み書きするアーム付きのヘッド**から構成されている。シーク処理は、データのある位置までアームを移動させ、目的のトラックに到達後、ディスクの回転で目的のセクタ（扇形の領域）がヘッド下に来るのを待ってから、読み書きが行われる
        - 性能改善のためには、シークを減らす設計（例：データの物理的なまとまり）や、SSDへの移行が重要。
    - 単純な圧縮アルゴリズムは早い
    - 可能であれば、インターネット送信前にデータを圧縮する
    - データセンターにデータを送るのに時間はかかる

## 可用性の数値

- 望ましく長い時間にわたって継続的に稼動するシステムの能力
- 表
    - p47

## TwitterのQPSと必要なストレージの見積もり

### 前提条件

- 月間アクティブユーザー 3億人
- 50%のユーザーが毎日Twitterを利用
- ユーザーは1日平均2件のツイートを投稿
- ツイートの10%はメディア
- データは5年間保存

### 推定値

- クエリ / 秒(QPS)
    - 1秒間あたりに処理されるクエリ（リクエスト）の数
- QPSの推定値
    - デイリーアクティブユーザー(DAU) 3億人 × 50% 1億5000万人
    - ツイートのQPS =  1億5000万人 × 2ツイート / 24時間 / 60分 / 60秒　= ~ 3500
    - ピーク時のQPS = 2 × QPS = ~ 7000
- 必要なメディアストレージ
    - メディア 1メガバイト
    - 1億5000万人 × 2 × 10% × 1MB = 30TB / 日
    - 5年間のメディア保存料 30TB × 365日 × 5年間 = ~ 55PB