## 単一サーバーのセットアップ

![IMG_6574.jpeg](attachment:62f9e1f0-c50b-48cd-a39d-189186d14bb3:IMG_6574.jpeg)

## データベース

![IMG_6579.jpeg](attachment:b1727ea4-d5c3-4922-8559-9d9f69e88eaa:IMG_6579.jpeg)

- 1台のサーバーでは足りなくなり、Web/モバイルトラフィック用のサーバーとDB用のサーバーとで分離

### どのデータベースを使うか

- リレーショナルDB
    - 他テーブルとの結合が可能
    - ほとんどのケースで最適な選択肢
- NoSQL
    - 一般的には結合ができない
    - 特定のユースケースで適しているかもしれない
        - アプリケーションに超低遅延がある場合
        - 非構造化データを扱う場合、リレーショナルなデータがない場合
        - データのシリアライズ、デシリアライズだけが必要な場合
        - 大量データの保存が必要な場合

### 垂直スケーリングと水平スケーリング

- 垂直スケーリング
    - スケールアップを指し、サーバーのパワー(CPU、RAMなど)を追加する
    - トラフィックが少ない場合は、シンプルで利点ある
    - 制約
        - 垂直スケーリングはハードウェアとしての限界あり。1台のサーバーに無制限にCPUとメモリを追加することは不可能
        - 垂直スケーリングはフェイルオーバーや冗長性がない。1台のサーバーがダウンすると、Webサイトやアプリケーションも完全にダウンする(単一障害点のリスク)
        - 全体的にコストが高くなる
- 水平スケーリング
    - スケールアウトを指しさらにサーバーを追加するアプローチ
    - 大規模なアプリケーションでは望ましい
    - シャーディングとも呼ばれる
        - 大規模なデータベースを、シャードというパーツに分割する
            - 各シャードは同じスキーマを共有するが、各シャード上の実際のデータはそのシャード固有
        - シャーディングされたkDBから対象の値を取得する一例
            
            p38, p39
            
            ユーザーデータはユーザーIDに基づいてDBサーバーに割り当てられており、データにアクセスすると、ハッシュ関数を使って対応するシャードを探し出す
            
        - シャーディングキー
            - データの分散方法を決定する一つないし複数の列で構成されている
            - データを均等に分散できるキーを選択する必要がある
        - 課題
            - データの再シャーディング
                - 急激なデータ増加や、データの分布が不均一なため、特定のシャードが他よりもシャードを使い果たす場合に実施する
            - セレブ問題(ホットスポットキー問題)
                - 特定のシャードへの過度なアクセスは、サーバーの過負荷を引き起こす可能性が高い
            - 結合と非正規化
                - データベースが複数のサーバーにまたがって、シャーディングされると、データベース間でのjoin操作を行うことが難しくなる

### データーベースレプリケーション

![IMG_6576.jpeg](attachment:b7a4ab5a-ff6b-4c60-9c7f-f4a344760762:IMG_6576.jpeg)

- マスターベースとスレーブデータベース
    - マスターベースは、書き込みのみをサポートする。
        - 挿入、削除、更新はすべてマスターベースへ
    - スレーブデータベースは、マスターデータベースからデータのコピーを取得し、読み込みのみをサポートする
- レプリケーションの利点
    - パフォーマンスの向上
        - 書き込みはマスター、読み込みはスレーブで分散して行われるため、より多くのクエリを並列で処理でき、パフォーマンスが向上する
    - 信頼性
        - 自然災害でDBサーバーが破壊されてもデータは保全される
    - 高い可用性
        - DBを複数の場所に複製することで、一つのDBがオフラインになっても、別のデータベースサーバーに保存されているデータにアクセスできる
            - スレーブデータベースが一つしかなく、それがオフラインになった場合、読み取り操作は一時的にマスターへ
            - マスターベースがオフラインになった場合、スレーブデータベースが新しいマスターに設定される

## ロードバランサ

![IMG_6577.jpeg](attachment:d55c0893-23a2-48f5-b146-9bb79236438e:IMG_6577.jpeg)

- 受信したトラフィックをロードバランサ・セットで定義されたWebサーバーに均等に分散させる
- ユーザーはロードバランサのパブリックIPに直接接続する。ロードバランサ ↔ ウェブサーバーの通信はセキュリティ向上のため、プライベートIPを使用する。
- ロードバランサと2台目のWebサーバーを追加したことにより、フェイルオーバーの問題を解決し、可用性が向上
    1. サーバー1がオフラインになった場合、すべてのトラフィックがサーバー2にルーティングされる。これによりWebサイトがオフラインになることを防げる
    2. Webサイトのトラフィックが急増し、2台のサーバーでは処理しきれない場合、ロードバランサによって新たにサーバーを追加し、スケールアウトする。

## キャッシュ

- 高いレスポンスや頻繁にアクセスされるデータの結果をメモリに保存し、後続のリクエストをより迅速に処理されるようにする一時的な記憶領域
- キャッシュは一時的なデータストアであり、DBよりもはるかに高速。独立したキャッシュ層を持つことの利点は、システムの性能の向上、DB作業不可の軽減につながる
    
    ![IMG_6578.jpeg](attachment:ecf0b653-ce24-4cf5-9653-cb20da8d3401:IMG_6578.jpeg)
    

### 注意点

- キャッシュを使用するタイミングの決定
    - データの読み取り頻度が高く、変更頻度が低い場合はキャッシュの使用を検討
- 有効期限ポリシー
    - 有効期限ポリシーがないと、キャッシュされたデータは永久にメモリに保存されるため、ポリシーを儲けるのは良いアプローチである
    - 有効期限を短くすると、DBからデータを頻繁に再読み込みすることになるため、有効期限を短くしないことが推奨されるが、一方で有効期限を長くし過ぎるとデータが古くなる可能性があるため、期限は慎重に検討する必要がある
- 一貫性
    - データストアとキャッシュの間の一貫性を維持するのは困難
- 障害の軽減
    - 単一のキャッシュサーバーは、潜在的な単一障害点(SPOF)を意味する
        - 単一障害点+ システムの一部で、それが故障するとシステム全体の動作が停止してしまう箇所
    - → 複数のキャッシュサーバーを使用することを推奨
- 消去ポリシー
    
    キャッシュが一杯になり、キャッシュにアイテムが追加されるリクエストがあると、既存アイテムが削除される可能性がある。LPUやLFUなど様々な消去ポリシーからユースケースに応じて選定する必要がある
    

## コンテンツデリバリーネットワーク(CDN)

- 地理的に分散したサーバーのネットワークであり、静的コンテンツを配信するために使用される
- ユーザーがWebサイトにアクセスすると、そのユーザーに最も近いCDNサーバーから静的コンテンツを配信する

![IMG_6589.jpeg](attachment:aba897ec-eab0-4bf9-96b4-7446df468d2b:IMG_6589.jpeg)

### 注意点

- コスト
    - CDNへのデータ転送とCDNからのデータ転送に課金される。使用頻度の低いコンテンツはキャッシュしても大きなメリットがないため、CDNからの移動を検討する必要がある
- 有効期限の適切な設定
    - キャッシュと同様、長すぎず短すぎず、最適な期限を検討する
- CDNフォールバック
    - CDNが一時的に停止したばい、クライアントがその問題を検知し、オリジンサーバーからリソースをリクエストできるようにする必要がある

## ステートレスWeb層

- Web層のスケーリングを考える上で、状態(例えばユーザーの認証情報)をWeb層の外に移す必要がある

### ステートフルアーキテクチャ

- サーバーはあるリクエストから次のリクエストまでの状態を記憶するが、複数サーバーがある場合は、その状態を記憶したサーバーにルーティングされるようにする必要がある
- 同じクライアントからの全リクエストを同じサーバーにルーティングする必要があり、手間がかかる

![IMG_6590.jpeg](attachment:5bb5f0b8-79de-4c7e-a66e-a7c3c450a921:IMG_6590.jpeg)

### ステートレスアーキテクチャ

- ユーザーからのリクエストは任意のWebサーバーに送られ、状態データは共有データストアからデータを取得する。
- 状態データはWebサーバーには残らず、共有データストアに保存される
    - 共有データストアの例はRDBやRedis, NoSQLなど
- よりシンプルで堅牢でスケラーブルである

![IMG_6591.jpeg](attachment:338f0123-92db-479e-b4bd-6a58efb2a74c:IMG_6591.jpeg)

## データセンター

グローバル向けに可用性を高め、より広い地域でよりよりユーザー体験を提供するには、複数のデータセンターをサポートすることが重要になる

### ジオDNSルーティング(ジオルーティング)

- ユーザーの位置に基づいてドメイン名をIPアドレスに割り当てるDNSサービス
- ジオルーティングによって、最も近いデータセンターへリクエストを送る
    
    ![IMG_6616.jpeg](attachment:a74cd022-ed2b-4741-be43-de7e1fb308b9:IMG_6616.jpeg)
    
    - データセンターに障害が起きた場合は、すべてのトラフィックを問題のないデータセンターへ誘導する

### マルチデータセンター化を達成する上での技術的課題

- トラフィックのリダイレクト
    - トラフィックを適切なデータセンターに誘導するための効果的なツールが必要。ジオDNSにて実現可能
- データの同期
    - 異なる地域のユーザーは、異なるローカルデータベースやキャッシュを使用するかもしれない。
    - 一般的な戦略は複数のデータセンター間で、データを複製すること
- テストとデプロイ
    - Webサイトやアプリケーションを異なるロケーションで手usとすることが重要になる

## メッセージキュー

- メモリに格納された耐久性のある構成要素であり、非同期通信をサポートする
- Ex. 写真加工アプリケーション
    - Webサーバーがメッセージキューに写真処理ジョブを発行し、写真処理ワーカーはメッセージキューからジョブを受け取り、非同期に写真のカスタマイズタスクを実行する
    
    ![IMG_6618.jpeg](attachment:2f251882-ff47-41ea-ae4a-9661074eedf6:IMG_6618.jpeg)
    

## ログ取得、定量化、自動化

- ログ取得
    - エラーログの監視は、システムにおけるエラーや問題の特定に役立つ
- 定量化
    - 様々な種類の定量データを収集することで、ビジネス上の洞察やシステムの健康状態を理解できる
        - ホストレベルの定量データ: CPU、メモリ、ディスクI/O
        - 集計レベルの定量データ: DB層全体、キャッシュ層のパフォーマンス
        - ビジネス指標: デイリーアクティブユーザー、収益、その他
- 自動化
    - 継続的インテグレーションによる各コードのチェックインを自動化で検証。問題の早期発見を可能とする
    - ビルド、テスト、デプロイのプロセスなどの自動化により、生産性を向上

## 数百万ユーザーとそれ以上に対応するために

- Web層はステートレスに保つ
- 各階層で冗長性を確保する
- できる限りデータをキャッシュする
- 複数のデータセンターへの対応
- 静的アセットをCDNでホスティング
- シャーディングによるデータ層の拡張
- 各サービスに階層を分割する
- システムの監視と自動化ツールの使用
