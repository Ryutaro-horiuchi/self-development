## 前提

- 水平スケーリングを実現するには、サーバー間で効率よく均等にリクエスト / データを分散させることが重要。
- コンシステントハッシュは、この目標を達成するためによく使われる技術
    - AWS
        
        
        | サービス | 使われ方 |
        | --- | --- |
        | **Amazon DynamoDB** | 内部的にDynamoの論文の思想を採用。コンシステントハッシュをベースにパーティションを分散配置 |
        | **ElastiCache (Redis Cluster)** | シャード間のキー分散にハッシュスロットを使用（実質的にコンシステントハッシュに近い仕組み） |
        | **Amazon S3** | 直接的に「コンシステントハッシュ」とは呼ばれないが、オブジェクトキーをハッシュして分散配置 |
        | **Amazon Kinesis** | パーティションキーをハッシュしてシャードにルーティング |
    - Google Cloud
        
        
        | サービス | 使われ方 |
        | --- | --- |
        | **Cloud Spanner** | データ分割時の負荷分散にハッシュベースのパーティション分割（コンシステントハッシュの考え方に近い） |
        | **Memorystore for Redis (Cluster)** | Redis Clusterと同様にキーをハッシュスロットにマッピング |
        | **Pub/Sub** | メッセージのOrdering Keyをハッシュして特定のシャードに割り当て |
        | **Firestore / Bigtable** | キーをハッシュ化してホットスポットを防ぎつつ分散配置 |

## 再ハッシュ問題

- キャッシュサーバーが n 台ある場合、負荷分散させる一般的な方法として以下のようはハッシュ方式がある
    
    ```
    serverindex = hash(key) % N
    
    N = サーバープールの大きさ
    ```
    
    - Ex. サーバープールが4でキーが保存されているサーバーを取り出すには、hash(key) % 4を実行する。得られた答えが1だった場合、キャッシュされたデータを取り出すためにサーバー1に連絡する必要があることを意味する
    - イメージ
        
        ![](attachment:fc97ec37-236d-4e60-afbf-f2196e384a39:IMG_6755.jpg)
        
        ![](attachment:2c71c146-634d-49e1-90cc-3332bab431ef:IMG_6756.jpg)
        
- 問題
    - 新しいサーバーが追加されたり、既存のサーバーが削除されたりすると問題が発生する
    - イメージ
        
        ![](attachment:1dfbf7a2-66d0-459a-973f-00700bf18c4a:IMG_6757.jpg)
        
    - 同じハッシュ方式を使用するとほとんどのキーが再配布され、キャッシュクライアントはデータを取得するために誤ったサーバーに接続することとなり、キャッシュミスだらけとなる

## コンシステントハッシュ

- ハッシュ空間(ハッシュリング)を作成し、専用のハッシュ関数を用いてサーバーにリングをマッピングする方法
- キーをハッシュ関数を用いてハッシュのリングにハッシュ化され、キーがどのサーバーに保存されているかを調べるには、リング上のキーの位置から時計回りにサーバーが見つかるまで移動する

### 追加

- サーバー追加されても、キー0のみが再配布が必要であり、影響範囲は限定的
- イメージ
    
    ![](attachment:d76ac157-c9fe-41d6-87ec-5539d23c8bc4:IMG_6760.jpg)
    

### 削除

- サーバーが削除されても、小ンシステントハッシュで再割り当てが必要なキーはごく一部
- イメージ
    
    ![](attachment:1c9cb229-d45f-4443-a506-1121fc82bbd1:IMG_6761.jpg)