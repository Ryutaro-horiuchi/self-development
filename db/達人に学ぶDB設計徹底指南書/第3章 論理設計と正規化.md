# テーブルとは何か？

- テーブルとは同じ種類の物の集合である
- 集合であるため、アメリカのDBエンジニアであるジョー・セルコは「 テーブル名はすべて複数形、または複数名詞で書ける」と表現している
    - → 複数で表現できなければ、そのテーブルにはどこか違いがある

# テーブルの構成要素

## キー

---

- キーとなる列には、コードやIDなど表記体系の定まった固定長文字列を使用する
- 「名前」などの可変長文字列は、微妙に表記が違うだけで異なる値となってしまい、データをうまく取得できなくなる恐れがあるため

### 主キー

- テーブルに置いて、必ず一つだけ存在するべき
- その値を指定すれば、必ず1行のレコードを特定できるような列の組み合わせのこと
- 複合キー
    - 複数列を組み合わせて作る主キーのことを複合キーと呼ぶ
- 候補キー
    - 主キーとして利用可能なキーが複数存在した場合、それら「候補」となるキーのこと

### 外部キー

- 二つのテーブル間の列同士で設定する
- 役割は、「参照整合性制約」を課す
    - Ex.  社員と部署テーブル
        - 写真1
        
        ![IMG_1400.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/e65ac49a-f550-4328-9a35-4fcec385bcfd/IMG_1400.jpeg)
        
        - この例では、部署テーブルに存在しないような部署のデータが、間違って社員テーブルに登録されないように防止する
- 外部キーは人間の親子関係と同一
    - 親で定義されていない値を子では定義できないが、子で定義されていなくても親だけで定義することは可能
- カスケード
    - 親のレコードが削除された時に、子のデータも合わせて削除する操作を「カスケード」と呼ぶ
    - 一番良いのは、子のデータから削除するのが吉

## 制約

---

- NOT NULL制約
- 一意制約
    - ある列の組について一意性を求める制約
- CHECK制約
    - ある列の取りうる値の範囲を設定する

# 正規化

- 正規形とは
    
    データベースで保持するデータの冗長性を排除し、一貫性と効率性を保持するためのデータ形式
    
- 第一から第五まで正規形はあるが、通常の業務で使用するレベルとしては、第三正規形まで理解すれば十分。

## 第一正規形

---

- 前提
    
    便宜的にテーブルの列と行が交差する特定のマスのことをExcelなどの用語にならって「セル」と呼ぶとする
    
- 第一正規形の定義
    
    <aside>
    💡 **「一つのセルの中には一つの値しか含まない」**
    
    (付随して、主キーを決められるようにする )
    
    </aside>
    

### 第一正規化を行う

- 非正規形のテーブル
    
    ![IMG_1401.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/38297107-e049-47c5-9a11-56975695686f/bd0b5998-1237-44c8-af3e-78ca468a9223.png)
    
    - 一つのセルに複数の値を入れてしまうのは、リレーショナルデータベーつでは重大な規則違反になる
- 第一正規形 その１
    
    ![IMG_1401.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/2e23d017-5be2-4a85-8c4c-e682e8d884cf/b5ab55a8-74b7-42c1-b92b-d7a44b131e8e.png)
    
    - 子の数だけ列を増やす方法。
    - その2の方が推奨
- 第一正規形 その２
    
    ![IMG_1402.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/4e706e5e-8073-443d-9972-a67ac818ebd5/4c6ef0fc-c21b-456c-8295-714770c0b227.png)
    
    - この数だけ行を増やした方法
    - 問題点が2つある
        - 主キーを決められない
            - 一レコードを特定しようとすると、社員ID, 社員名, 子のすべてを指定せざるを得ないが、社員名 「藤本」は子がおらず、NULLになってしまう
                
                <aside>
                💡 キーは一部であってもNULLを含めてはならない決まりがある
                
                </aside>
                
        - テーブルが意味的に「社員」と「扶養者」という二つのエンティティを含んでしまい、テーブルの意味やレコードの単位をすぐに理解できない
- 第一正規形 その３
    
    ![IMG_1403.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/f3a2233b-0e82-458e-8e74-55acbf9ebcf2/107fb76b-4c7e-4f89-ac21-6c1ed853077f.png)
    

### なぜ一つのセルに複数の値を入れてはダメなのか？

- 一つのセルに複数の値が入ることを許してしまうと、各列の値を一意に決定できず、主キーの定義に反してしまうから
    
    → 関数従属性が成り立たなくなるから
    
    - 関数従属性
        
        X列(入力)の値が決まれば、Y列(出力)の値が**一つ**に決まる
        

## 第二正規形

---

- 第二正規形の定義
    
    <aside>
    💡 部分関数従属をなくして、完全関数従属のみのテーブルを作成すること
    
    </aside>
    
    - 部分関数従属
        - 主キーの一部の列に対して従属する列があること
    - 完全関数従属
        - 主キーを構成するすべての列に従属性があること

### 第二正規化を行う

- 部分関数従属の関係にある組み合わせを別テーブルにする
- 異なるレベルの実態を、きちんとテーブルとしても分離してやる作業だということ
- 第二正規形ではないテーブル
    
    ![IMG_1404.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/6f4d843e-0764-403a-b994-0a429c18c936/5990fdf1-b808-4968-beff-77fe1939591b.png)
    
    - 主キーは会社コード, 社員ID
    - 会社名列だけは、主キーの一部である会社コードに従属している部分関数従属である
- 第二正規形テーブル
    
    ![IMG_1405.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/8ec4cce7-d47c-4c7f-b515-9ac95a288610/c72c0fa4-f45d-4d19-89ce-5c91ec2a1aee.png)
    
    - 部分関数従属の関係である会社コードと会社名だけ、別のテーブルに独立させる

## 第三正規形

---

- 第三正規形の定義
    
    <aside>
    💡 二段階の関数従属(推移的関数従属)をなくす
    
    </aside>
    

### 第三正規化を行う

- 第三正規形ではないテーブル
    
    ![IMG_1405.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/8ec4cce7-d47c-4c7f-b515-9ac95a288610/c72c0fa4-f45d-4d19-89ce-5c91ec2a1aee.png)
    
    - 部署コードは、部署名と従属関係にある |部署コード| → |部署名|
    - 社員IDは部署コードと従属関係にある  |社員ID| → |部署コード|
    - 全体として、|社員ID| → |部署コード| → |部署名| という二段階の従属関係が発生している
    
- 第三正規形
    
    ![IMG_1406.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/2518224a-4114-4f17-9a10-af306bb7d974/24a2b7f6-c252-47f6-a7e1-f1ecca5dbe13.png)
    
    ![IMG_1407.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/a89f097a-5c96-49af-b2a4-def9513c4a86/3c25f1b2-1ae0-49f0-ba12-63784ead0f62.png)
    
    テーブルを分割して、それぞれの関数従属の関係を独立させる
    

## 正規化は常にするべきか？

- 第三正規形までは、原則として行う
- 関連エンティティが存在する場合は、関連とエンティティが1対1になるように注意する

正規化を行えば行うほど、以下のメリットがある

- データの冗長性が排除され、更新時の不整合を防止できる。
- テーブルの持つ意味が明確になり開発者が理解しやすい

正規化のデメリット

- テーブル数が増えるため、SQL文で結合を多用することになり、パフォーマンスが悪化する