## 配列型による非スカラ値

---

- 1999年に標準SQLに盛り込まれた
    - プログラミング言語では、配列型を持っているため、RDBのみ配列型が扱えないと不便ではあった
    - 一方で、これまで厳正な正規化をポリシーとしていただけに、その原則を崩すには抵抗があったが、標準SQLとして採用された
- テーブルの一つの列を配列として扱うことができる
    
    → **非スカラ値を含むテーブルを作成できる**点で、従来のリレーショナルデータベースの型破りとも言える
    
- 一般的に普及するまでには至らなかった
    - DBと接続するアプリケーションやミドルウェアも、対応しなければ意味がなく、実用化へのハードルが高い
- 現状は第一正規系を確保することを優先すべき
    
    → 配列型を採用したとしてもアプリケーションや、ミドルウェアの整合性を考慮しなくてはならない。設計にかかるコスト増になる
    
    - 配列は列ではなく、行として持たせるのが好ましい

### スカラ値の基準は何か？

- 意味的に分割できる限り、分割して保持するという基本方針が良い
    - 分解されたものを結合するのは容易であるのに対し、結合されたものを分解するのは難しいから
    - Ex. 「名前」ではなく、「first_name」「last_name」に分ける

## ダブルミーニング

---

- 一つの列が二つの意味を持ってしまっている
    
    テーブルの列は「変数」ではない。一度意味を決めたら変更不可
    

## 単一参照テーブル

---

- イメージ
    
    ![IMG_1422.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/44941e33-b60a-40b6-a678-f37156c0af5d/IMG_1422.jpeg)
    
- あらゆるタイプのマスターテーブルを、一つのテーブルにまとめている
- テーブル全体が、ある時は「会社」、ある時は「性別」と変化する
    - ダブルミーニングの応用

### メリット

- マスターテーブルの数が減るため、ER図がシンプルになる
- コード検索のSQLを共通化できる

### デメリット

- ER図がシンプルになるとは言っても、ERモデルとしては正確さを欠いており、かえってER図の可読性を下げることになる
- 一つのテーブルにレコードを集約するため、コード体系の種類、数の多さによってはレコード数が多くなり、検索のパフォーマンスが悪化する
- 検索の中で、コードタイプを間違って指定してもエラーにならないため、バグに気づきにくい

## テーブル分割

---

テーブル分割は水平分割と垂直分割に分かれる

### 水平分割

- レコード単位に分割する
    
    データが膨大な場合に、レコード数を減らしてパフォーマンス改善をはかるため
    
- Ex. 会社の売上テーブル
    - 分割前
        
        ![IMG_1423.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/3a280bbe-ef82-4a50-aeb9-a46822d4a165/ea335003-dd6f-4a28-8004-aab3bd8feb92.png)
        
    - 分割後
        
        ![IMG_1424.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/1ae22016-7ca9-43cc-bf8f-e5fd27225f3c/e59809d6-31ad-4fbc-92bd-3129f560797b.png)
        
- デメリット
    - 分割する意味的な理由がない
        - このように分割する理由が、正規化の理論からは出てこない
    - 拡張性に乏しい
        - Exで言うと、全年度のデータを検索することがないという前提が成り立つ時のみに限られる
        - 年度が増えるたびにテーブルが増え、それに伴いアプリケーション側も改修が必要になる
    - 他の代替手段 「パーティション」がある
        - パーティションキーを軸として論理的には単一のテーブルとし、物理的に格納領域を分離することが可能になる
        - インデックスよりもカーディナリティが小さく、かつ値の変更があまり起きない列をキーにして利用する
            
            典型的な例は、　「年」や「都道府県」など
            

### 垂直分割

- 列単位に分割する
- Ex. 社員テーブル
    - 分割前
        
        ![IMG_1425.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/0f9db229-100c-4583-b8e7-bfa540a5e3f9/IMG_1425.jpeg)
        
    - 分割後
        
        ![IMG_1426.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/a9bf60d1-50ef-4dde-a028-ae13b16c8a96/IMG_1426.jpeg)
        
- デメリット
    - 水平分割と同じく、分割する意味的な理由がない
    - 他の代替手段「集約」がある

### 集約

---

- テーブル分割の代替案に位置付けられる。「列の絞り込み」と「サマリテーブル」の2種類に分けられる
- 列の絞り込み
    - イメージ図
        
        ![IMG_1427.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/f194b231-9972-4be5-a1db-bf89eaca40e2/IMG_1427.jpeg)
        
    - オリジナルのデータは残し、保持する列を絞った新しいテーブル(データマート)を作成する
        - オリジナルのテーブルは残すため、「分割」ではない
    - オリジナルのテーブルを意味的に破壊することなく、パフォーマンスを向上させられるため、実際の現場でもよく使われている
    - オリジナルのテーブルと定期的に同期する必要がある
        - 更新タイミングが短いほど、オリジナルのテーブルとの齟齬をなくせるが、更新処理の負荷が高くなり、かえって性能を悪化させてしまう危険性がある
- サマリテーブル
    - イメージ図
        
        ![IMG_1428.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/55cf0dd1-2dee-468a-a433-643a5d3e4ab8/IMG_1428.jpeg)
        
    - あらかじめ集約関数を実行した結果を、新たなテーブルに持たせる
    - 行列ともに元の社員テーブルより小さくなり、アクセスする時のI/Oコストを大きく削減する効果がある。
    - オリジナルテーブルを変更することもないため、分割によるデメリットもない
    - データマートと同じく、データを定期的に同期する必要がある

p213  不適切なキー

ここでのキー

- 主キー、外部キー、テーブルの結合キー
- VARCHAR(可変長文字列)は使ってはいけない
    - 不変性がないため、キーには不向き
- 固定長文字列のコード列が望ましい

p216

ダブルマスタ(著者の造語)

同じ意味のテーブルが二つ存在する

システムの統廃合で起きることが多い