## 正規化の功罪

---

データの整合性を保持するための正規化にも副作用がある

<aside>
💡 正規化されたテーブル群に対するSQLが非常に遅くなってしまう

</aside>

### 実例

- 正規化の場合
    
    ![IMG_1414.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/c50efd0c-dcc4-4822-a895-f147072c1c5f/38780542-1b01-479c-abab-84e8fdbc7c67.png)
    
    - 要望
        1. 田島さんが勤めている会社と部署名を取得したい (検索)
            - SQL
                
                ```sql
                SELECT 会社.会社名, 社員.社員名
                  FROM 社員 INNER JOIN 会社
                            ON 社員.会社コード = 会社.会社コード
                WHERE 社員.社員名 = '田島';
                
                ```
                
                - 内部結合して取得する必要がある
        2. A商事がE物産という会社に吸収されたので、データを更新する(更新)
            - SQL
                
                ```sql
                
                UPDATE 会社
                   SET 会社名 = 'E物産'
                 WHERE 会社コード = 'C0001';
                ```
                
                - 一つの会社のみの更新になるため、処理のコストは常に低い
                
- 非正規化の場合
    
    ![IMG_1415.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/11cbba63-e9b2-4136-a5f8-c8d795e3dd3b/81645977-eb08-4eae-8af0-640680b81eb9.png)
    
    - 要望
        1. 田島さんが勤めている会社と部署名を取得したい (検索)
            - SQL
                
                ```sql
                SELECT 会社名,社員名,部署名
                  FROM 社員
                 WHERE 社員名 = '田島';
                ```
                
        2. A商事がE物産という会社に吸収されたので、データを更新する(更新)
            - SQL
                
                ```sql
                UPDATE 社員
                   SET 会社名 = 'E物産'
                 WHERE 会社コード = 'C0001';
                　
                ```
                
                - 社員の人数分更新をする必要があるため、処理に時間がかかる
- 検索に関しては、非正規化の方がSQLがシンプルであり、結合を利用しないためパフォーマンスが良い
- 更新に関しては、正規化の方が常に対象が一つのレコードのみとなるため、パフォーマンスが良い

### 正規化と非正規化、どちらが正解なのか？

- エンジニアや評論化によって意見が分かれる
    - 正規化と検索SQLのパフォーマンスは強いトレードオフの関係にあるため
        
        <aside>
        💡 正規化の次数が低いほど、検索SQLのパフォーマンスは良いが、データ整合性が低く、正規化していくほど、パフォーマンスが低下する代わりにデータ整合性が高くなる
        
        </aside>
        

## 非正規化のリスク

---

- 更新不整合のリスクが増える
- 検索のパフォーマンスは向上させるが、更新のパフォーマンスを低下させる
- データのリアルタイム性を低下させる
    - 非正規化で商品数という列を持たせた場合、定期的に商品数が更新されるものとして考えた際、負荷を踏まえてこの更新をどの頻度で反映するのか
    - ユーザーにとっては即座に反映してくれるのは嬉しいが、反映周期が短ければ短いほど、負荷はかかる