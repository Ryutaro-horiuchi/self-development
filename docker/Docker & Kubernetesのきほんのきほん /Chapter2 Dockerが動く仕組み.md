## Dockerの仕組み

---

物理マシンの上にLinuxOS。LinuxOSの上にDockerEngineを載せ、その上でコンテナを動かす

### 前提: OSとは

- ソフトウェアなどのプログラムの命令をハードウェアに伝える役割を担うもの
    - ソフトウェア → 周辺の部分 → カーネルに伝わり、カーネルがハードウェアを操作する
- 「カーネル」と呼ばれる核となる部分と、「周辺の部分」で構成されている
    - 周辺の部分がプログラムからの命令を受け取ったり、カーネルの実行した結果をプログラムに伝えたりする
    - 周辺の部分のパッケージがディストリビューションと呼ばれ、有名なディストリビューションには、Red Hat、CentOS、Ubuntuなど
    - カーネルだけでLinuxを使用することはほぼなく、ディストリビューションとセットで使うため、「Linuxは Red Hat」を使っているなど、ディストリビューションの名前で言われることが多い

### コンテナの中にはOSっぽいものが入っている

- コンテナには必ずLinuxOSっぽいものが入っている
    
    → Dockerは完全に他の環境と隔離されているため、OSっぽいもの(周辺部分)が入っていないと土台となるOSに命令を伝えられない
    
    - コンテナ内のソフトウェア → OSっぽいもの → Docker Engine → カーネル → ハードウェア
- OSっぽいもの(周辺部分)を入れて、土台をカーネルに任せることでコンテナの軽量化を体現している

### Dockerは基本的にLinux用のもの

- Dockerは、土台となるLinuxOSを使用する前提の仕組みであるため、LinuxOSでないと動かない
- それに伴い、コンテナの中に入れるOSの周辺部分やこソフトウェアもLinux用でないといけない
    
    → macやwindowsのソフトウェアは入らない
    

### WindowsやMacでDockerを動かす

- 2通りのケースがある
    - VirtualBoxやVMwareのような仮想環境の上にLinuxOSをインストールして動かしているケース
    - Dockerの実行に必要なLinuxOSを含むパッケージをインストールしているケースがある
        - Ex. Docker Desktop for Mac
    
    → どちらも MacOS(Windows)の上に、LinuxOSを強引に入れて動かしている
    

## イメージ

---

- イメージとは金型のようなもの
    - 1つあれば、同じコンテナを量産できる
- コンテナからもイメージを作成できる
- イメージがあることで、DockerからDockerへ移動できる
    - 別のサーバーやパソコン上でもDocker Engineをインストールして元のコンテナから作成したイメージを使用すれば良い

### Docker Hub

- 公式が運用しているDockerレジストリ
- 誰でも公開できる
- 安全なコンテナイメージの選び方
    - 公式が提供しているイメージを使う
    - 元となるOS入りコンテナを選んだ後は、自分でカスタムする

### 色々な組み合わせが考えられるコンテナ

- Dockerの特徴的な使い方の一つに、1コンテナ1アプリという考え方がある
    - Ex. WordPressの構築
        - 一つのコンテナにWordPress、Apache、MySQLをインストールするか
        - 3つコンテナを用意し、それぞれのコンテナにWordPress、Apache、MySQLをインストールするか
- 全部入りコンテナ
    - すぐに稼働が可能なため重宝する
- 「OSっぽいもの」は統一する必要があるか
    - 土台となるLinuxOS, コンテナの中のOSっぽいもののディストリビューション及びバージョンは異なっていても問題ない

## コンテナのライフサイクル

---

- Dockerコンテナは作っては捨てる
    - 一つのコンテナに入っているソフトウェアのアップデートをしていくのではなく、新しいバージョンのコンテナに乗り換える
- コンテナのライフサイクル
    
    作る　⇒ 　起動する　⇒　停止する　⇒　破壊する　⇒　作るといった流れのこと。
    

### データの保存

- 廃棄の時に、コンテナの中のデータは全て消える

→ コンテナの中にデータを保存したままにしておくのではなく、物理的なマシンのディスクにマウントして保存する

## Dockerのメリット・デメリット

### メリット

- 1台の物理的なマシンに複数のサーバーを載せられる
    - → 隔離されているため、セキュアな状態で普通ではありえないような組み合わせ(同じソフトウェアを複数など)が可能
    - 仮想化技術よりも軽量
- サーバーの管理がしやすい
    - 隔離されているため、他のソフトウェアに影響がしない
    - アップデートもしやすいため、常に新しい状態にソフトウェアを保ちやすい

### デメリット

- Linux用のソフトウェアしか対応していない
- 1つの物理的なマシンにたくさんのサーバーを載せてしまうため、親となるマシンが駄目になった場合、全てのコンテナが影響を受ける
- コンテナ1つを長期にわたって運用し続けるのはメリットを受けにくい