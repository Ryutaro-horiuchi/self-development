# ファイルのコピーをする

---

- コンテナからホスト、ホストからコンテナへファイルをコピーすることが可能
    - コンテナからホストへコピー
        
        ```bash
        % docker cp ホスト側パス コンテナ名: コンテナ側パス
        ```
        
    - コンテナからホストへコピー
        
        ```bash
        % docker cp コンテナ名: コンテナ側パス ホスト側パス
        ```
        

# ボリュームのマウント

---

## ボリュームとマウント

- ボリューム
    
    ストレージの1領域を区切ったもの
    
    → 長いカステラの一切れのようなイメージ
    
- マウント(取り付けるという意味)
    
    対象を接続して、OSやソフトウェアの支配下に置く
    
    → USBメモリをパソコンに挿すと、フォルダが開ける(USBメモリをパソコンにマウントしている)
    

## データの永続化

- コンテナは作っては壊す性質のため、データはコンテナ内部にもたせず外に持たせる
    
    <aside>
    💡 記憶領域をマウントして、外のデータを操作できるようにする必要が出てくる
    
    </aside>
    

## 記憶領域のマウント(ボリュームのマウント)の種類

Dockerに記憶領域をマウントするには2種類の方法がある

- ボリュームマウントとバインドマウントの違い
    
    
    | 項目 | ボリュームマウント | バインドマウント |
    | --- | --- | --- |
    | 記憶領域 | ボリューム | ディレクトリやファイル |
    | マウント場所 | Docker Engine 管理下 | どこでも可能 |
    | マウント時の動作 | ボリュームを作成してマウント | 既存のファイルやフォルダをマウント |
    | 内容の編集 | Dockerコンテナを経由して行う | 普通のファイルとして扱う |
    | バックアップ | 複雑な手順 | 普通のファイルとして扱う |

### ボリュームマウント

- Docker Engineが管理している領域内にボリュームを作成して、ディスクとしてコンテナにマウントする
- ボリュームを直接操作しづらいため、仮で使いたい場合や、滅多に触らないが消してはいけないファイルを置くのに使うことが多い

### バインドマウント

- Docker Engineの管理していない場所の既にあるディレクトリをコンテナにマウントする
- 頻繁にファイルを編集する必要があるときは、ここに置く

## 記憶領域をマウントする

- 記憶領域をマウントするとは
    
    記憶領域をコンテナに取り付ける
    
- マウントする手順
    - 記憶領域を作る → コンテナを作る

### 記憶領域を作るコマンド

- バインドマウントの場合、フォルダやファイルを通常通り用意する
- ボリュームマウントの場合は、ボリューム系コマンドを使用する
    - ボリュームの作成
        
        `docker volume create ボリューム名`
        
    - ボリュームの削除
        
        `docker volume rm ボリューム名`
        

### 記憶領域をマウントするコマンド

- バインドマウントのよく使う記述例
    
    `docker run (省略) -v 実際の記憶領域パス：コンテナの記憶領域パス (省略)`
    
- ボリュームマウントのよく使う記述例
    
    `docker run (省略) -v ボリューム名：コンテナの記憶領域パス (省略)`
    
- コンテナの記憶猟奇パスは、そのソフトウェアが、コンテンツを保有する場所をマウントするケースが多い
    - Ex. Apache `/user/local/apache2/htdocs`
    - Ex. MySQL `/var/lib/mysql`

### ハンズオン バインドマウントしてみよう

- ハンズオン
    1. マウントするディレクトリを作成する
    2. runコマンドでApacheコンテナを起動する
        
        ```bash
        % docker run
        	--name apabex20
        	-d 
        	-p 8090:80 
        	-v /Users/ユーザー名/Documents/apa_folder:/user/local/apache2/htdocs 
        	httpd
        ```
        
    3. ブラウザでApacheにアクセスしてみる
    4. apa_folderディレクトリの中にindex.htmlを入れる
    5. inex.htmlが変わったことを確認する
    6. 後始末を行う - コンテナの削除

### ハンズオン ボリュームマウントしてみよう

- ハンズオン
    1. マウントするボリュームを作成する
        
        ```bash
        docker volume create apa000vol1
        ```
        
    2. runコマンドでApacheコンテナを起動する
        
        ```bash
        docker run
        	--name apa000ex21
        	-d
        	-p 8091:80
        	-v apa000vol1:/usr/local/apache2/htdocs
        	httpd
        ```
        
    3. volume inspectコマンドでボリュームの詳細情報を表示
        
        ```bash
        docker volume inspect apa000vol1
        
        docker container inspect apa000ex21
        ```
        
    4. 後始末を行う - ボリューム、コンテナの削除
        
        ```bash
        docker volume list
        docker volume rm apa000vol1
        ```
        

# コンテナのイメージ化

---

2つ方法がある

- commitで書き出す
- Dockerfileでイメージを作成する

## commitで書き出す

- 既にあるコンテナからイメージを作成したい場合に使用する
- コマンド
    
    ```bash
    % docker commit <コンテナ名> <作成するイメージ名>
    ```
    

## Dockerfileでイメージを作成する

- いろいろなことができそうな印象を持たれるが、イメージを作ることしかできない。いわば「Docker image file」とも言える
- 元となるイメージや、実行したいコマンドなどを記載する
- このファイル自体は、ホストの適当な場所に作った材料フォルダの中に入れる
    - 材料フォルダには、イメージに含めたいファイルも置いておく
- コマンド
    
    ```bash
    % docker build -t <作成するイメージ名> <材料フォルダのパス>
    ```
    
- Dockerfileの記述例
    
    ```bash
    FROM イメージ名
    COPY コピー元パス コピー先パス
    RUN Linuxのコマンド
    ...
    ```
    
- Dockerfileでのコマンド 一例
    
    
    | コマンド | 内容 |
    | --- | --- |
    | FROM | 元にするイメージを指定する |
    | COPY | イメージにファイルやフォルダを追加する |
    | ADD | イメージにファイルやフォルダを追加する |
    | RUN | イメージをビルドするときにコマンドを実行する |
    | CMD | コンテナを起動するときに実行する規定のコマンドを指定する |
    | ENV | 環境変数を定義する |
    | WORKDIR | RUN CMD ENTRYPOINT ADD COPYの際のディレクトリを指定する |

### ハンズオン Dockerfileでイメージを作ろう

- ハンズオン
    
    1.　材料フォルダを用意する
    
    フォルダ内にはindex.htmlのみ用意する
    
    1. Dockerfileを作成する
        
        ```docker
        FROM httpd
        COPY index.html /usr/local/apache2/htdocs/
        ```
        
    2. buildコマンドを実行してイメージを作る
        
        ```bash
        % docker build -t ex22_original2 /Users/ryutafolder/Documents/apa_folder
        ```
        
    3. イメージが作成されたことを確認する `docker image ls`
    4. 後始末を行う
        
        コンテナと作成したイメージ「ex22_original2」を削除する
        

# コンテナの改造

方法は2種類

1. ファイルのやり取り
    
    ファイルをコピーしたり、記憶領域をマウントしたりする
    
2. コンテナに対して、Linuxのコマンドで命令する

## コンテナに対して、Linuxのコマンドで命令する

---

- 命令を通してソフトウェアのインストールを行ったり、設定を書き換えたりする
- 命令を伝えるには、shellが必要。shellを起動させるにはdocker runコマンドや、docker execコマンドの引数に /bin/bash をつけて行う
    - docker exec
        
        ```bash
        % docker exec (オプション) コンテナ名 /bin/bash
        
        % docker exec -it apa000ex23 /bin/bash
        ```
        
        - コンテナの中でコマンドを実行する。起動中のコンテナに命令をしたい時に使用する
        - bashを使わずに、execコマンドである程度の命令はできるが、初期設定されていないがために動かないことがあるので、基本的にはシェルを通して実行する
    - docker run
        
        ```bash
        
        docker run (オプション) イメージ名 /bin/bash
        
        docker run --name apa000ex23 -it -p 8089:80 httpd /bin/bash
        ```
        
        - runコマンドに/bin/bashをつけて実行したときは、イメージのソフトウェアは起動されない
            - bashでの操作が終わった後に、改めて「docker start」コマンドでスタートさせる必要がある
- bashを起動したら操作対象はDocker Engineではなく、コンテナになるため、Dockerコマンドは使用できなくなる
    
    → コンテナから抜けるにはexitコマンドを使用する
    

### コンテナのLinuxの種類に応じてコマンドが変わる

- コンテナの中に入っているOSっぽいものが、LinuxOSのどのディストリビューションなのかでパッケージ管理のインストールコマンド等が変わってくる
- 公式では「特に理由がなければDebian系をベースにすると良い」という方針を出している
- Ex. Apacheのインストール
    - Debian系  `apt install apache2`
    - Red Hat系 `yum install httpd`

# イメージの保管

## Docker HubとDockerレジストリ

---

- イメージの配布場所のことをDockerレジストリと呼ぶ
    - 一般に公開されている・否にかかわらず、配布場所のことを指す
- DockerHubはDockerレジストリのうち、Docker公式が運営しているイメージ配布場所

### レジストリとリポジトリ

- レジストリはイメージの配布場所
    - 会社単位、部署単位で作られることが多い
- リポジトリは、レジストリの中をさらに区切った単位
    - ソフトウェア単位で作られる
- Docker Hubの場合は、リポジトリがそれぞれIDを持つ形になっている
    
    → Docker Hubの中に各社・個人のレジストリが大量にある
    

## イメージのアップロード

---

### タグの命名

- アップロードする際にはタグをつける必要がある
    - タグのフォーマット: レジストリの場所とバージョン表記
- Ex.  タグの命名
    - フォーマット
        
        ```bash
        レジストリの場所/リポジトリ名:バージョン名
        ```
        
    - Ex.
        
        ```bash
        zoozoo.coomm/nyapacchi:13
        							
        ```
        
    - プライベート
        - 自身のPCに作ったレジストリで作成する場合
            
            ```bash
            localhost:5000/ nyapacchi:13
            ```
            
        - 独自のドメイン(zoozoo.coomm)のレジストリで作成する場合
            
            ```bash
            zoozoo.coomm/nyapacchi:13
            ```
            
    - DockerHub
        
        zoozoousagiというDockerHubのIDで、作成する場合
        
        ```bash
        zoozoousagi/nyapacchi:13
        ```
        

### イメージにタグ名をつけて複製する

- コマンド
    - フォーマット
        
        ```bash
        docker tag 元のイメージ名 レジストリの場所/命名したいリポジトリ名:バージョン
        ```
        
    - Ex.
        
        ```bash
        docker tag apa000ex22 zoozoo.coomm/nyapacchi:13
        ```
        

### イメージをアップロードする

- pushコマンドを使用する
    - フォーマット
        
        ```bash
        docker push タグ名(レジストリの場所/リポジトリ名:バージョン)
        ```
        
    - Ex.
        
        ```bash
        
        docker push zoozoo.coomm/nyapacchi:13
        ```
        

## レジストリを作るには

---

### プライベートなDockerレジストリを作る方法

- レジストリ用コンテナがあるので、それを使用する
    
    → レジストリもDockerで運用する
    
- コマンド
    
    ```bash
    docker run -d -p 5000:5000 registry
    ```
    

### Docker Hubを使う

- プライベートな設定にしておけば、クローズドな環境で使用できる