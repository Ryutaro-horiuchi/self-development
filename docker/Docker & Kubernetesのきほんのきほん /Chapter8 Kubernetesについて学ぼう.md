# kubernetesとは

---

コンテナのオーケストレーションツール(システム全体の統括をし、複数のコンテナを管理できるもの)

- オーケストラと同じ楽団員を指揮者が指揮するように、複数のコンテナを管理するのがKubernetes。
- k8sと略すことも

## Kubernetesは、複数の物理的なマシンに複数のコンテナがあることが前提

- 1台1台の物理的なマシンの中に、複数のコンテナがある
    
    (物理的なマシンは、仮想マシンで構成することもある)
    
    - 複数のコンテナを1台ずつ作成したり、管理したりするのは大変なため、Kubernetesがある
    - 例えば 20個のコンテナを作ろうと思ったら、20回docker runコマンドを使用することになる

# マスターノードとワーカーノード

---

- Kubernetesはマスターノードと呼ばれるコントロールを司るノードとワーカーノードという実際に動かすノードで構成される
- ノードはおおよそ物理的なマシンと同じだと考える
    
    → クラスターの作り方によっては、物理的マシンではないこともある
    

## マスターノード

- ワーカーノード上のコンテナを管理する
    
    (現場監督のようなもので、大工で言えば棟梁に当たる。)
    
- マスターノード上ではコンテナは動かないため、Docker Engineなどのコンテナエンジンもインストールしない

## ワーカーノード

- 実際のサーバーに当たる部分でコンテナが動作するマシン。
- Docker Engineなどのコンテナエンジンもインストールされている必要がある

## クラスター

- マスターとワーカーで構成されたKubernetesのシステムの一群をクラスターと呼ぶ
- クラスターは自立して動くため、管理者のパソコンから直接ワーカーノードを管理することはない。
    
    → 管理者(人)はマスターノードの初期設定・調整のみ行う
    

## Kubernetesを使うには、Kubernetesのインストールが必要

---

Kubernetesは、Docker Engineなどのコンテナエンジンとは別のソフトウェア

### マスターノードとワーカーノード共通してインストールするもの

- Kubernetesのソフトウェア
- CNI(仮想ネットワークのドライバ)
    - 代表的なのはflannel、Calico、AWS VPC CNI

### マスターノードのみ

- コンテナなどの状態管理のためにetcdというDBを入れる

### ワーカーノードのみ

- Docker Engineなどのコンテナエンジンを入れる

### 管理者のPC

マスターノードの設定を行うのに、kubectl(クーべシーティーエル / クーべコントロール)を入れる

→ マスターノードにログインして初期設定を行ったり調整をする

## マスターノード 構成

---

マスターノードは、コントロールプレーン(制御盤)でワーカーノードを管理する

- コントロールプレーンは5つの部品で管理されている。
    
    
    | 項目 | 内容 |
    | --- | --- |
    | kube-apiserver | 外部とやり取りをするプロセス。kubectlからの命令を受け取って実行する |
    | kube-controller-manager | コントローラーを統括管理・実行する |
    | kube-scheduler | Podを、ワーカーノードへと割り当てる |
    | cloud-controller-manager | クラウドサービスと連携して、サービスを作る |
    | etcd | クラスター情報を全管理するデータベース |
    - etcd以外は、Kubernetesに入っているため、etcdとKubernetesをインストールすればすべて入る

## ワーカーノード 構成

---

- ワーカーノードは、kube-letとkube-proxyが動く。
    
    
    | 項目 | 内容 |
    | --- | --- |
    | kube-let | マスターノード側のkube-schedulerと連携して、ワーカーノード上にPod(コンテナとボリューム)を配置し実行する。また、実行中の状態を定期的に監視し、kube-scheduelrへ通知する |
    | kube-proxy | ネットワーク通信をルーティングする仕組み |

![IMG_1365.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/a07a2b8c-8124-43de-ac1e-abaef324adac/IMG_1365.jpeg)

# Kubernetesは常に望ましい状態に保つ

---

- DockerComposeは、作成時のみオプションの指定によって、コンテナの数を指定できるが、監視はしていないため、「作って終わる」のに対し、Kubernetesは「その状態を維持する」
    - Ex. コンテナを4つ ボリュームを4つをKubernetesでリリース
        - → コンテナが1つ壊れたら、そのコンテナを自動で削除して新しいコンテナを1つ作成する

## Kubernetesを使ったシステムのコンテナ削除

- 直接コマンドでコンテナを削除するのではなく、設定ファイルでコンテナ数を指定して削除を行う
    - → 直接コマンドでコンテナを削除すると、設定ファイルの「状態」と整合が取れず、新たにコンテナをKubernetesが作成してしまうため

## コラム

- 増減しやすい仕組みのことをスケーラビリティと呼ぶ
- Kubernetesの定義ファイルは、データベースとして管理される
    - 作成した定義ファイルは、etcdに書き込まれる

# Kubernetesの構成と用語

---

## Pod

- Kubernetesでは、コンテナはPodという単位で管理される
- Podはコンテナとボリュームがセットになったもの
    - 基本的に1Pod 1コンテナだが、コンテナは複数にすることもできる
    - ここでのボリュームは、Podの中での複数のコンテナが情報を共有するために使用するものであり、作らないこともある

## Podを束ねるサービス

- 同一の構成のPodをまとめて管理する
    - Podを束ねる班長のようなもの
    - Podが複数のワーカーノード(マシン)に存在している場合でも、まとめて管理する
- ロードバランサーの役割を果たしている
    - サービス一つ一つに固有のIPアドレスが付与されており、通信をPodへ適切に振り分ける
        
        → 各々のワーカーノードへの振り分けは、本物のロードバランサーで行われる
        

## デプロイメントとレプリカセット

### レプリカセット

- サービスと同じく同一の構成のPodをまとめて管理するが、こちらはPodの数を管理する班長
    - Podが障害で一部停止してしまった場合に、足りない文を増やしたりする。定義ファイルのPodの数が変更されたら、その分数を変更する
- レプリカセットにより管理されている同一構成のPodをレプリカと呼ぶ
    - Podを増減することを、レプリカを増やす・減らすと言ったり、Podの数を決めることをレプリカの数を決めるとも言ったりする

### デプロイメント

- Podのデプロイを管理するもの、どのイメージを使うかなど
- イメージとして、レプリカセットが班長だとしたらデプロイメントはその上司

## リソース

Pod、サービス、デプロイメント、レプリカセットなどをリソースと呼ぶ。

リソースは50種類ぐらいあるが、実際に使うのは少ない

## Kubernetesの用語まとめ

![IMG_1366.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/42b16988-a5a8-437d-af8b-c8412ee1342b/cc15a1a4-51c5-4a6e-859b-7095e5a05a51/IMG_1366.jpeg)