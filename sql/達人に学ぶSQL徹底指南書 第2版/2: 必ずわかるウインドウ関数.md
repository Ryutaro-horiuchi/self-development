## ウインドウ関数とは

- 以下の3つの句を使用している
    - PARTITION BY句
        - レコード集合を区切っている
            - GROUP BYとは違って集約はしない
    - ORDER BY句
        - PARTITION BY句で区切った中で並び替えをしている
    - フレーム句
        - カレントレコードを中心としたサブセットの定義
            - カレントレコードを中心にさらに対象を区切っている
        

## ウインドウ構文

---

### 無名ウインドウ

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka,
			 // 無名ウインドウ
       AVG (hanbai_tanka) OVER (ORDER BY shohin_id                         
                                ROWS BETWEEN 2 PRECEDING                   
                                         AND CURRENT ROW) AS moving_avg    
  FROM Shohin;
```

- よく使用される

### 名前付きウインドウ

```sql
SELECT shohin_id, shohin_mei, hanbai_tanka,
       AVG(hanbai_tanka) OVER W AS moving_avg
  FROM Shohin
WINDOW W AS (ORDER BY shohin_id
                 ROWS BETWEEN 2 PRECEDING 
                          AND CURRENT ROW);
```

- 一部のRDBMSでは使用できない
- ウインドウの使い回しができる

## ウインドウ関数 応用

---

### フレーム句を使って集計結果に、違う行を自分の行に持ってくる(行間比較)

- Ex. 直前のデータを求める
    - LoadSampleテーブル(サーバーの時間ごとの負荷量を記録したテーブル)
        
        
        | sample_date(計測日) | load_val(負荷量) |
        | --- | --- |
        | 2018-02-01 | 1024 |
        | 2018-02-02 | 2366 |
        | 2018-02-05 | 2366 |
        | 2018-02-07 | 985 |
        | 2018-02-08 | 780 |
        | 2018-02-12 | 1000 |
    - 直前のデータを求める(1行前のデータを求める)
        
        ```sql
        SELECT sample_date AS cur_date,
               MIN(sample_date)
                  OVER (ORDER BY sample_date ASC
                         ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS latest_date
          FROM LoadSample;
        
        +------------+-------------+
        | cur_date   | latest_date |
        +------------+-------------+
        | 2018-02-01 | NULL        |
        | 2018-02-02 | 2018-02-01  |
        | 2018-02-05 | 2018-02-02  |
        | 2018-02-07 | 2018-02-05  |
        | 2018-02-08 | 2018-02-07  |
        | 2018-02-12 | 2018-02-08  |
        +------------+-------------+
        ```
        
        - ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING
            - フレーム句の範囲を直前の1行前までに限定する
        - load_valも上記と同じ記法で、直前の負荷量を算出することができる