## 自己結合とは

- 同一のテーブルに行うことを自己結合と呼ぶ
- 自己結合の考え方
    
    本当に異なるテーブルを結合していると考えると理解しやすい
    

## 順列(順序対)・組み合わせ(非順序対)を得る

- イメージテーブル 果物と値段
    
    
    | りんご | 50 |
    | --- | --- |
    | みかん | 100 |
    | バナナ | 80 |
- 順列(順序対)
    - 順序を考慮した組み合わせ
        
        ```sql
        SELECT P1.name AS name_1, P2.name AS name_2 
          FROM Products P1 CROSS JOIN Products P2;
          
        +-----------+-----------+
        | name_1    | name_2    |
        +-----------+-----------+
        | バナナ    | りんご    |
        | みかん    | りんご    |
        | りんご    | りんご    |
        | バナナ    | みかん    |
        | みかん    | みかん    |
        | りんご    | みかん    |
        | バナナ    | バナナ    |
        | みかん    | バナナ    |
        | りんご    | バナナ    |
        +-----------+-----------+
        ```
        
    - 同一要素を取り除く
        
        ```sql
        
        -- 順列を得るSQL
        SELECT P1.name AS name_1, P2.name AS name_2 
          FROM Products P1 INNER JOIN Products P2;
            ON P1.name <> P2.name;
        
        +-----------+-----------+
        | name_1    | name_2    |
        +-----------+-----------+
        | バナナ    | りんご    |
        | みかん    | りんご    |
        | バナナ    | みかん    |
        | りんご    | みかん    |
        | みかん    | バナナ    |
        | りんご    | バナナ    |
        +-----------+-----------+
        ```
        
- 組み合わせ(非順序対)
    
    ```sql
    -- 組み合わせを得るSQL
    SELECT P1.name AS name_1, P2.name AS name_2 
      FROM Products P1 INNER JOIN Products P2 
        ON P1.name > P2.name;
    
    +-----------+-----------+
    | name_1    | name_2    |
    +-----------+-----------+
    | りんご    | みかん    |
    | みかん    | バナナ    |
    | りんご    | バナナ    |
    +-----------+-----------+
    ```
    
    - `ON P1.name > P2.name;`
        - 文字コードの順にソートして、自分より(ここでは)前にくる商品だけをペアの相手に選ぶ
    - 「=」以外の比較演算子を使用して行う結合を非等値結合と呼ぶ
        - ここでは自己結合と組み合わせているため、自己非等値結合である
    

## 重複行を削除する

- イメージテーブル 果物と値段
    
    
    | りんご | 50 |
    | --- | --- |
    | みかん | 100 |
    | みかん | 100 |
    | みかん | 100 |
    | バナナ | 80 |
- SQL
    
    ```sql
    -- 重複行を削除するSQLその1: 極値関数の利用
    DELETE FROM Products P1 
     WHERE rowid < ( SELECT MAX(P2.rowid) 
                       FROM Products P2 
                      WHERE P1.name = P2. name 
                        AND P1.price = P2.price );
    ```
    
    - [相関サブクエリ](https://www.notion.so/10c577f5217c4d1080b886077241e47d?pvs=21)
    - 全列が重複しているため、実装依存のレコードIDを使用する
        - 実装依存のレコードID
            - Oracle(`rowid`)とPostgreSQL(`oid`)しかない
            - 「どんなテーブルでも使用できる主キー」という特徴を持つ擬似列
    - 非等値結合を使用しても可能
        
        ```sql
        -- 重複行を削除するSQLその2: 非等値の利用
        DELETE FROM Products P1 
         WHERE EXISTS ( SELECT * 
                          FROM Products P2 
                         WHERE P1.name = P2.name 
                           AND P1.price = P2.price 
                           AND P1.rowid < P2.rowid );
        ```
        

## 部分的に不一致な行の検索

- 前提
    - 住所録テーブル(Addresses)を使用する
        
        ```sql
        +--------------+-----------+----------------------------------+
        | name         | family_id | address                          |
        +--------------+-----------+----------------------------------+
        | 前田義昭     |       100 | 東京都港区虎ノ門3-2-29           |
        | 前田由美     |       100 | 東京都港区虎ノ門3-2-92           |
        | 加藤勝       |       200 | 東京都新宿区西新宿2-8-1          |
        | 加藤茶       |       200 | 東京都新宿区西新宿2-8-1          |
        | ホームズ     |       300 | ベーカー街221B                   |
        | ワトソン     |       400 | ベーカー街221B                   |
        +--------------+-----------+----------------------------------+
        ```
        
    - 前田夫妻のように片方のアドレスが間違っている場合に、修正のため「同じ家族だけど住所が違うレコード」を検出することとする
- 本題
    
    ```sql
    SELECT A1.name, A1.address 
      FROM Addresses A1 INNER JOIN Addresses A2 
        ON A1.family_id = A2.family_id 
       AND A1.address <> A2.address ;
       
    +--------------+--------------------------------+
    | name         | address                        |
    +--------------+--------------------------------+
    | 前田義昭     | 東京都港区虎ノ門3-2-29         |
    | 前田由美     | 東京都港区虎ノ門3-2-92         |
    +--------------+--------------------------------+
    2 rows in set (0.00 sec)
    ```
    
    - 自己非等値結合を使用することで簡単に検出が可能に